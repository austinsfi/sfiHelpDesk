<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slack Alerter & Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script> <!-- Socket.io client -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .message {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* Hide the default file input button */
        #screenshot-input {
            display: none;
        }
    </style>
</head>
<body class="bg-slate-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto">
        <div class="bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl shadow-blue-500/10 flex flex-col">

            <div class="p-6 border-b border-slate-700">
                <div class="flex items-center justify-center gap-2">
                    <h1 id="header-title" class="text-2xl font-bold text-center">Steel Forgings CNC Helpdesk</h1>
                    <div class="flex items-center gap-1.5" title="Status: Online">
                        <div class="h-2.5 w-2.5 rounded-full bg-green-400 animate-pulse"></div>
                        <span class="text-xs text-green-400 font-medium hidden sm:block">Online</span>
                    </div>
                </div>
                <p class="text-sm text-slate-400 text-center mt-1">Press a button for a quick alert or type your issue below. Attach a screenshot if needed.</p>
            </div>

            <div id="message-container" class="flex-grow p-6 space-y-4 overflow-y-auto h-80 bg-slate-900">
                <div class="message flex items-start gap-3">
                    <div class="bg-blue-500 rounded-full h-8 w-8 flex-shrink-0 flex items-center justify-center font-bold text-sm">I</div>
                    <div>
                        <p class="font-semibold text-slate-300">IT Helpdesk <span class="text-xs text-slate-500 font-normal ml-1">Just now</span></p>
                        <div class="bg-slate-700 p-3 rounded-lg mt-1 text-slate-200">
                            <p>Use the buttons below to send an alert to IT, otherwise type a message below with your issue.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 border-t border-slate-700 bg-slate-800/80 rounded-b-2xl">

                <div id="heat-treat-warning" class="hidden p-3 mb-4 bg-yellow-900/50 border border-yellow-700 rounded-lg text-yellow-300 text-sm">
                    <p><span class="font-bold">Note:</span> Any issues with ERP please comment the issue you are having and IT will be there ASAP.</p>
                </div>

                <button id="send-alert-btn" class="w-full bg-red-600 hover:bg-red-700 transition-all duration-200 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 mb-4 shadow-lg shadow-red-500/20 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-500 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-800 disabled:opacity-50">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    Send Quick HELP Request (Mill 20)
                </button>

                <div id="heat-treat-buttons" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                    <button data-message="üö® URGENT: ERP Issues üö®" data-alert="true" class="ht-quick-btn w-full bg-red-600 hover:bg-red-700 transition-all duration-200 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 shadow-lg shadow-red-500/20 disabled:opacity-50">
                        üö® ERP Issues
                    </button>
                    <button data-message="üñ•Ô∏è PC Hardware Issues üñ•Ô∏è" data-alert="false" class="ht-quick-btn w-full bg-blue-600 hover:bg-blue-700 transition-all duration-200 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 shadow-lg shadow-blue-500/20 disabled:opacity-50">
                        üñ•Ô∏è PC Hardware Issues
                    </button>
                    <button data-message="üìä Grafana Issues üìä" data-alert="false" class="ht-quick-btn w-full bg-blue-600 hover:bg-blue-700 transition-all duration-200 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 shadow-lg shadow-blue-500/20 disabled:opacity-50">
                        üìä Grafana Issues
                    </button>
                    <button data-message="üè≠ Production Overview Issues üè≠" data-alert="false" class="ht-quick-btn w-full bg-blue-600 hover:bg-blue-700 transition-all duration-200 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 shadow-lg shadow-blue-500/20 disabled:opacity-50">
                        üè≠ Production Overview Issues
                    </button>
                </div>

                <p class="text-xs text-slate-500 text-center mb-2">
                    Need a screenshot? Press <strong>Win + Shift + S</strong>, then paste (<strong>Ctrl+V</strong>) in the message box.
                </p>

                <div class="flex items-center gap-2">

                    <input type="file" id="screenshot-input" accept="image/*">

                    <button id="attach-file-btn" class="bg-slate-600 hover:bg-slate-700 transition-all duration-200 text-white font-bold py-3 px-4 rounded-lg flex-shrink-0 shadow-lg disabled:opacity-50">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>

                    </button>

                    <input type="text" id="message-input" placeholder="Type your message here..." class="flex-grow bg-slate-700 border border-slate-600 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200 disabled:opacity-50">

                    <button id="send-message-btn" class="bg-blue-600 hover:bg-blue-700 transition-all duration-200 text-white font-bold py-3 px-4 rounded-lg flex-shrink-0 shadow-lg shadow-blue-500/20 disabled:opacity-50">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>

                <div id="file-preview-container" class="hidden text-sm text-slate-400 mt-2 flex items-center justify-between">
                    <span id="file-preview-name"></span>
                    <button id="clear-file-btn" class="text-red-400 hover:text-red-300 font-bold text-lg">&times;</button>
                </div>

            </div>
        </div>
    </div>

<script>
    // --- Get All New Elements ---
    const messageContainer = document.getElementById('message-container');
    const sendAlertBtn = document.getElementById('send-alert-btn');
    const sendMessageBtn = document.getElementById('send-message-btn');
    const messageInput = document.getElementById('message-input');

    const attachFileBtn = document.getElementById('attach-file-btn');
    const screenshotInput = document.getElementById('screenshot-input');
    const filePreviewContainer = document.getElementById('file-preview-container');
    const filePreviewName = document.getElementById('file-preview-name');
    const clearFileBtn = document.getElementById('clear-file-btn');

    let millId = 'Unknown Mill';
    let isSending = false;
    let selectedFile = null; // To hold the selected file
    let currentThreadTs = null; // To hold the timestamp of the current Slack thread

    // --- Socket.io Connection ---
    const socket = io();

    socket.on('new_message', (data) => {
        // Make sure we are in the correct thread
        if (data.thread_ts === currentThreadTs) {
            console.log('New message from Slack:', data);
            // NOTE: You might want to resolve the user ID to a name here
            addMessageToUI('Slack User', data.text, 'received');
        }
    });

    // --- Function to toggle sending state ---
    function setSendingState(sending) {
        isSending = sending;
        sendAlertBtn.disabled = sending;
        sendMessageBtn.disabled = sending;
        messageInput.disabled = sending;
        attachFileBtn.disabled = sending;
        clearFileBtn.disabled = sending;

        const htButtons = document.querySelectorAll('.ht-quick-btn');
        htButtons.forEach(btn => btn.disabled = sending);
    }

    // --- Function to clear the selected file ---
    function clearFile() {
        selectedFile = null;
        screenshotInput.value = null; // Clear the input
        filePreviewContainer.classList.add('hidden');
        filePreviewName.textContent = '';
        attachFileBtn.classList.remove('bg-green-600', 'hover:bg-green-700'); // Remove green "active" color
    }

    // --- Function to send to our OWN backend ---
    async function sendToSlack(message, isAlert = false) {
        if (isSending) return;

        // If we already have a thread, we are sending a reply
        if (currentThreadTs) {
            handleSendMessage();
            return;
        }

        if (!message && !selectedFile) {
            alert('Please type a message or attach a file.');
            return;
        }

        setSendingState(true);

        const formData = new FormData();
        formData.append('message', message);
        formData.append('mill', millId);
        formData.append('isAlert', isAlert);

        let displayMessage = message;
        if (selectedFile) {
            const fileName = selectedFile.name || 'Pasted-Image.png';
            formData.append('screenshot', selectedFile, fileName);
            displayMessage = `${message}\n(Attached: ${fileName})`;
        }

        addMessageToUI('You', displayMessage, 'sent');
        addMessageToUI('System', 'Sending to Slack...', 'received', 'sending-status');

        try {
            const response = await fetch('/api/send', {
                method: 'POST',
                body: formData,
            });

            const result = await response.json();
            const sendingMsg = document.getElementById('sending-status');
            if (sendingMsg) sendingMsg.remove();

            if (!response.ok || !result.success) {
                throw new Error(result.error || 'Server returned an error.');
            }

            // --- THIS IS THE KEY CHANGE ---
            // Save the timestamp of the message to enable replies
            currentThreadTs = result.ts;
            console.log(`Started new thread with ts: ${currentThreadTs}`);

            messageInput.value = '';
            clearFile();

            // Disable alert buttons after the first message
            sendAlertBtn.disabled = true;
            const heatTreatContainer = document.getElementById('heat-treat-buttons');
            if (heatTreatContainer) {
                const htButtons = heatTreatContainer.querySelectorAll('.ht-quick-btn');
                htButtons.forEach(btn => btn.disabled = true);
            }


            addMessageToUI('IT Helpdesk', "We've received your message. You can reply here to add more details.", 'received');

        } catch (error) {
            console.error(error);
            const sendingMsg = document.getElementById('sending-status');
            if (sendingMsg) sendingMsg.remove();
            addMessageToUI('System', `Error: Could not send message. ${error.message}`, 'received');
        } finally {
            setSendingState(false);
        }
    }

    // --- Simulation function (unchanged) ---
    // This function is no longer needed as we have real-time updates
    /*
    function simulateSlackResponse(originalMessage) {
        setTimeout(() => {
            const responses = [
                "We've received your message and will look into it shortly.",
                "Acknowledged. The IT team has been notified.",
                "Thanks for the update. We're on it.",
                "Got it. An IT member will respond soon."
            ];
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            addMessageToUI('IT Helpdesk', randomResponse, 'received');
        }, 1500 + Math.random() * 1000);
    }
    */

    // --- UI function (updated for newlines) ---
    function addMessageToUI(sender, text, type, optionalId = null) {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `message flex items-start gap-3 ${type === 'sent' ? 'flex-row-reverse' : ''}`;

        if (optionalId) {
            messageWrapper.id = optionalId;
        }

        const avatar = document.createElement('div');
        let avatarStyles = 'bg-blue-500';
        if (type === 'sent') {
            avatarStyles = 'bg-indigo-500';
        } else if (sender === 'System') {
            avatarStyles = 'bg-slate-500';
        }
        avatar.className = `rounded-full h-8 w-8 flex-shrink-0 flex items-center justify-center font-bold text-sm ${avatarStyles}`;
        avatar.textContent = sender.charAt(0);

        const messageContent = document.createElement('div');
        messageContent.className = `flex flex-col ${type === 'sent' ? 'items-end' : 'items-start'}`;

        const senderP = document.createElement('p');
        senderP.className = 'font-semibold text-slate-300';
        const timeSpan = document.createElement('span');
        timeSpan.className = 'text-xs text-slate-500 font-normal ml-1';
        timeSpan.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        if (type === 'sent') {
            senderP.textContent = `You `;
            senderP.appendChild(timeSpan);
        } else {
            senderP.textContent = `${sender} `;
            senderP.appendChild(timeSpan);
        }

        const textDiv = document.createElement('div');
        let textStyles = 'bg-slate-700 text-slate-200';
        if (type === 'sent') {
            textStyles = 'bg-blue-600 text-white';
        } else if (sender === 'System') {
            textStyles = 'bg-slate-700 text-slate-400 italic';
        }

        // This makes \n (newlines) show up in the message
        textDiv.style.whiteSpace = 'pre-wrap';

        textDiv.className = `p-3 rounded-lg mt-1 ${textStyles}`;
        textDiv.textContent = text;

        messageContent.appendChild(senderP);
        messageContent.appendChild(textDiv);
        messageWrapper.appendChild(avatar);
        messageWrapper.appendChild(messageContent);
        messageContainer.appendChild(messageWrapper);
        messageContainer.scrollTop = messageContainer.scrollHeight;
    }

    // --- Page Load Script (unchanged) ---
    document.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        millId = urlParams.get('mill') || 'Default Mill';
        const openChat = urlParams.get('chat') === 'true';

        // If chat=true, try to fetch the latest thread for the mill
        if (openChat && millId !== 'Default Mill') {
            try {
                addMessageToUI('System', `Looking for previous chats for ${millId}...`, 'received', 'loading-status');
                const response = await fetch(`/api/threads/${millId}`);
                const loadingMsg = document.getElementById('loading-status');
                if (loadingMsg) loadingMsg.remove();

                if (response.ok) {
                    const data = await response.json();
                    currentThreadTs = data.ts;
                    console.log(`Found existing thread for ${millId} with ts: ${currentThreadTs}`);
                    
                    // Disable alert buttons as we are in a reply state
                    sendAlertBtn.disabled = true;
                    const heatTreatContainer = document.getElementById('heat-treat-buttons');
                    if (heatTreatContainer) {
                        const htButtons = heatTreatContainer.querySelectorAll('.ht-quick-btn');
                        htButtons.forEach(btn => btn.disabled = true);
                    }

                    addMessageToUI('IT Helpdesk', "Continuing previous conversation. You can reply here to add more details.", 'received');
                } else {
                     addMessageToUI('System', `No active chat found for ${millId}. Starting a new one.`, 'received');
                }
            } catch (error) {
                console.error('Error fetching thread:', error);
                const loadingMsg = document.getElementById('loading-status');
                if (loadingMsg) loadingMsg.remove();
                addMessageToUI('System', 'Could not fetch previous chat status.', 'received');
            }
        }
 
        const headerTitle = document.getElementById('header-title');
        const heatTreatWarning = document.getElementById('heat-treat-warning');
        const heatTreatButtons = document.getElementById('heat-treat-buttons');

        if (millId === 'Heat-Treat') {
            headerTitle.textContent = `Heat-Treat Helpdesk`;
            heatTreatWarning.classList.remove('hidden');
            heatTreatButtons.classList.remove('hidden');
            sendAlertBtn.classList.add('hidden');

            document.querySelectorAll('.ht-quick-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const message = button.dataset.message;
                    const isAlert = button.dataset.alert === 'true';
                    sendToSlack(message, isAlert);
                });
            });

        } else {
            if (millId !== 'Default Mill') {
                headerTitle.textContent = `${millId} Helpdesk`;
            }
            sendAlertBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                Send Quick HELP Request (${millId})
            `;
        }
    });

    // --- Event Listeners ---

    // Default Red Button
    sendAlertBtn.addEventListener('click', () => {
        const alertMessage = `üö® URGENT ALERT! Assistance needed immediately. üö®`;
        sendToSlack(alertMessage, true);
    });

    // Send text message (from button or Enter key)
    const handleSendMessage = async () => {
        const message = messageInput.value.trim();
        if (!message && !selectedFile) return; // Don't send empty messages or files

        // If we don't have a thread, this is the first message.
        if (!currentThreadTs) {
            if (message || selectedFile) {
                sendToSlack(message, false);
            }
            return;
        }

        // --- This is a REPLY ---
        setSendingState(true);
        let displayMessage = message;
        const formData = new FormData();
        formData.append('message', message);
        formData.append('thread_ts', currentThreadTs);

        if (selectedFile) {
            const fileName = selectedFile.name || 'Pasted-Image.png';
            formData.append('screenshot', selectedFile, fileName);
            displayMessage = `${message}\n(Attached: ${fileName})`;
        }

        addMessageToUI('You', displayMessage, 'sent');
        messageInput.value = ''; // Clear input immediately
        clearFile(); // Clear file immediately

        try {
            const response = await fetch('/api/reply', {
                method: 'POST',
                body: formData, // Send as FormData
            });

            if (!response.ok) {
                // If sending fails, put the message back in the input
                messageInput.value = message;
                // NOTE: We don't restore the file, as that's more complex.
                throw new Error('Server returned an error.');
            }
            // Message sent successfully
        } catch (error) {
            console.error('Error sending reply:', error);
            addMessageToUI('System', `Error: Could not send reply. ${error.message}`, 'received');
        } finally {
            setSendingState(false);
        }
    };

    sendMessageBtn.addEventListener('click', handleSendMessage);
    messageInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            handleSendMessage();
        }
    });

    // --- File Input Listeners ---

    // Trigger the hidden file input
    attachFileBtn.addEventListener('click', () => {
        screenshotInput.click();
    });

    // Clear the file
    clearFileBtn.addEventListener('click', () => {
        clearFile();
    });

    // Handle file selection
    screenshotInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            if (file.size > 20 * 1024 * 1024) { // 20MB limit
                alert('File is too large. Please keep it under 20MB.');
                clearFile();
                return;
            }
            selectedFile = file;
            filePreviewName.textContent = file.name;
            filePreviewContainer.classList.remove('hidden');
            attachFileBtn.classList.add('bg-green-600', 'hover:bg-green-700'); // Turn green
        } else {
            clearFile();
        }
    });

    // --- PASTE FROM CLIPBOARD ---
    messageInput.addEventListener('paste', (event) => {
        const items = event.clipboardData.items;
        for (const item of items) {
            if (item.type.indexOf('image') !== -1) {
                // We found an image!
                const file = item.getAsFile();

                if (file.size > 20 * 1024 * 1024) { // 20MB limit
                    alert('Pasted image is too large. Please keep it under 20MB.');
                    return;
                }

                selectedFile = file;
                filePreviewName.textContent = file.name || 'Pasted-Image.png'; // Provide a default name
                filePreviewContainer.classList.remove('hidden');
                attachFileBtn.classList.add('bg-green-600', 'hover:bg-green-700');

                // Stop the text from being pasted into the input field
                event.preventDefault(); 
            }
        }
    });

</script>
</body>
</html>